const fs = require('fs');
const axios = require('axios'); // ä½¿ç”¨ axios åº“è¿›è¡Œ HTTP è¯·æ±‚

async function fetchProxiesFromSubscription(url) {
  try {
    const response = await axios.get(url);
    const data = response.data; // å‡è®¾è¿”å›çš„æ•°æ®æ˜¯æ ‡å‡†çš„ Clash é…ç½®
    return data.proxies;
  } catch (error) {
    console.error(`Failed to fetch proxies from ${url}:`, error);
    return [];
  }
}

async function generateConfig() {
  const subscriptionUrls = [
    'https://example.com/subscription1.yaml',
    'https://example.com/subscription2.yaml'
  ];

  let proxies = [];
  for (const url of subscriptionUrls) {
    const fetchedProxies = await fetchProxiesFromSubscription(url);
    proxies = proxies.concat(fetchedProxies);
  }

  if (proxies.length === 0) {
    console.error('No proxies found.');
    return;
  }

  const proxyNames = proxies.map(proxy => proxy.name);

  const groups = [
    {
      "name": "ğŸš€ä¸æ—¶ä¹‹éœ€",
      "type": "select",
      "proxies": [
        "DIRECT",
        "âœ¨ä»£ç†æ¨¡å¼"
      ]
    },
    {
      "name": "ğŸŸæ¼ç½‘ä¹‹é±¼",
      "type": "select",
      "proxies": [
        "DIRECT",
        "âœ¨ä»£ç†æ¨¡å¼"
      ]
    },
    {
      "name": "âœ¨ä»£ç†æ¨¡å¼",
      "type": "select",
      "proxies": [
        "ğŸ¤–è‡ªåŠ¨é€‰æ‹©",
        "ğŸ¯æ‰‹åŠ¨é€‰æ‹©"
      ]
    },
    {
      "name": "ğŸ¤–è‡ªåŠ¨é€‰æ‹©",
      "type": "url-test",
      "url": "http://www.gstatic.com/generate_204",
      "interval": 300,
      "tolerance": 50,
      "proxies": proxyNames
    },
    {
      "name": "ğŸ¯æ‰‹åŠ¨é€‰æ‹©",
      "type": "select",
      "proxies": proxyNames
    },
    {
      "name": "â›”å¹¿å‘Šæ‹¦æˆª",
      "type": "select",
      "proxies": [
        "REJECT",
        "DIRECT",
        "âœ¨ä»£ç†æ¨¡å¼"
      ]
    }
  ];

  const rules = [
    "RULE-SET,reject,â›”å¹¿å‘Šæ‹¦æˆª",
    "RULE-SET,direct,DIRECT",
    "RULE-SET,cncidr,DIRECT",
    "RULE-SET,private,DIRECT",
    "RULE-SET,lancidr,DIRECT",
    "GEOIP,LAN,DIRECT",
    "GEOIP,CN,DIRECT",
    "RULE-SET,selfdomain,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,tld-not-cn,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,selfapp,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,applications,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,google,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,icloud,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "RULE-SET,apple,ğŸš€ä¸æ—¶ä¹‹éœ€",
    "DOMAIN-SUFFIX,hockeyapp.net,âœ¨ä»£ç†æ¨¡å¼",
    "DOMAIN-SUFFIX,firebaseio.com,âœ¨ä»£ç†æ¨¡å¼",
    "DOMAIN,usage.readdle.com,âœ¨ä»£ç†æ¨¡å¼",
    "DOMAIN,api.amplitude.com,âœ¨ä»£ç†æ¨¡å¼",
    "DOMAIN,app.smartmailcloud.com,âœ¨ä»£ç†æ¨¡å¼",
    "RULE-SET,gfw,âœ¨ä»£ç†æ¨¡å¼",
    "RULE-SET,greatfire,âœ¨ä»£ç†æ¨¡å¼",
    "RULE-SET,telegramcidr,âœ¨ä»£ç†æ¨¡å¼",
    "RULE-SET,proxy,âœ¨ä»£ç†æ¨¡å¼",
    "MATCH,ğŸŸæ¼ç½‘ä¹‹é±¼"
  ];

  const ruleProviders = {
    "reject": {
      "type": "http",
      "behavior": "domain",
      "url": "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",
      "path": "./ruleset/reject.yaml",
      "interval": 86400
    },
    "icloud": {
      "type": "http",
      "behavior": "domain",
      "url": "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt",
      "path": "./ruleset/icloud.yaml",
      "interval": 86400
    },
    // çœç•¥å…¶ä»–è§„åˆ™æä¾›è€…é…ç½®
  };

  const config = {
    'proxy-groups': groups,
    'rules': rules,
    'proxies': proxies,
    'rule-providers': ruleProviders
  };

  fs.writeFileSync('clash-config.yaml', YAML.stringify(config), 'utf8');
  console.log('Configuration file generated: clash-config.yaml');
}

// ç”Ÿæˆé…ç½®æ–‡ä»¶
generateConfig();
